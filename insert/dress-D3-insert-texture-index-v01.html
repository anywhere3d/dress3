<!DOCTYPE html>
<html>

<head>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="/icons/favicon.ico" type="image/x-icon">
    <meta name="description" contents="{{description}}">
    <title>Dress-D3: insert texture(v0.1)</title>
    <link rel="stylesheet" href="/vendor/bootstrap.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.1.1/gh-fork-ribbon.min.css">
    <link rel="stylesheet" href="/css/bootbox-dialoges.css">
    <link rel="stylesheet" href="/css/side-panels.css">
    <link rel="stylesheet" href="/css/messg.css" >
    <link rel="stylesheet" href="/css/spectrum.css">
    <link rel="stylesheet" href="/css/colorpicker.css">
    <link rel="stylesheet" href="/css/jquery-ui.css">
    <link rel="stylesheet" href="/css/alerts.css">
    <link rel="stylesheet" href="/css/panel-ui.css">
    <link rel="stylesheet" href="/css/anywhere3d.css">
    <!-- link rel="stylesheet" href="/css/login.css" -->

    <script src="/js/w3.js"></script>
    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery-ui.js"></script>
    <script> debugMode = true;</script>

</head>

<body>

<style>
    .navbar-nav > li > a.menu-item {font-weight:bold;}
</style>

<nav class="navbar navbar-default navbar-fixed-top">

    <div class="container">

        <div class="navbar-header">
            <div class="navbar-brand">
                <a href="/" class="navbar-caption" title="anywhere3d.com">anywhere3d</a>
            </div>
            <a class="navbar-logo pull-left"><img src="/icons/anywhere3d-girls-logo.png" alt="anywhere3d logo"></a>
            <ul class="nav navbar-nav navbar-right pull-left">
                <li class="first"><div></div></li>
            </ul>
        </div>
        
        <ul class="nav navbar-nav navbar-right"></ul>

    </div>

</nav>

<style>
    canvas { display:block !important; }
    #msg-box7-z { background-color:#eee; padding-top:0px; padding-bottom:0px; overflow:hidden; }
    #render-container { opacity:1; background-color:#eee; width:100%; height:660px; position:absolute; top:140px; overflow:hidden; }
    #left-side { top:50px; bottom:0px; }
    #left-side-content { overflow-y:auto; }
    #icon-img { margin-left:20px; float:right; }
    .img-height-auto { height:auto; }
</style>

<style>
    .center-vertical {height: 100vh;}
    .center-vertical form {top: 50%;margin: auto;position: relative;
      -webkit-transform: translateY(-50%);-ms-transform: translateY(-50%);
      transform: translateY(-50%);
    }
    .form-horizontal .form-buttons {float: right;}
    .form-horizontal .form-buttons .btn {width: 80px;margin-left: 6px;}
    .form-horizontal input,
    .form-horizontal select {height: 30px;}
    label.control-label.col-sm-2, 
    label.control-label.col-sm-3 { padding-top:5px; }
</style>

<section class="mbr-section mbr-after-navbar" id="msg-box7-z">

    <div class="container">
        
        <div class="col-sm-6 center-vertical">
            <div id="render-container"></div>
        </div>

        <div class="col-sm-6 center-vertical">

            <form class="well" id="dress3-form" method="post">

                <h2>Dress-D3 texture insert</h2>
                
                <div class="form-group">
                    <h6>Please insert a title for the texture:</h6>
                    <label class="control-label col-sm-2">Name:</label>
                    <div class="col-sm-10">
                        <input class="form-control" type="text" id="name-tf" name="name">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="control-label col-sm-2">Asset:</label>
                    <div class="col-sm-10">
                        <input class="form-control" type="text" id="asset-tf" name="asset" value="HF_DressLayer_FemaleBodyKitv05_v03" disabled>
                    </div>
                </div>
                <div class="form-group">
                    <label class="control-label col-sm-2">Gender:</label>
                    <div class="col-sm-4">
                        <select class="form-control" id="gender-list" name="gender" disabled>
                            <option value="">Please select a gender:</option>
                            <option value="male">male</option>
                            <option value="female" selected>female</option>
                        </select>
                    </div>
                </div>
                <div class="clearfix"></div>
                <div class="form-group">
                    <label class="control-label col-sm-2">Category:</label>
                    <div class="col-sm-4">
                        <select class="form-control" id="category-list" name="category" disabled>
                            <option value="">Please select a category:</option>
                            <option value="dress" selected>dress</option>
                        </select>
                    </div>
                </div>
                <div class="clearfix"></div>
                
                <hr/>

                <div class="form-group">
                    <label class="control-label col-sm-3">Icon:</label>
                    <h6>Please insert the URL adresses for the texture icon:</h6>
                    <input class="form-control" type="url" id="icon-tf" name="icon">
                </div>
                <div class="form-group">
                    <label class="control-label col-sm-3">Preview:</label>
                    <h6>Please insert the URL adresses for the texture preview:</h6>
                    <input class="form-control" type="url" id="preview-tf" name="preview">
                </div>
                <div class="form-group">
                    <label class="control-label col-sm-3">Texture:</label>
                    <h6>Please insert the URL adresses for the texture:</h6>
                    <input class="form-control" type="url" id="texture-tf" name="url">
                </div>

                <div class="form-group">
                    <h6>Please select a type for the texture:</h6>
                    <label class="control-label col-sm-2">Type:</label>
                    <div class="col-sm-4">
                        <select class="form-control" id="type-list" name="type">
                            <option value="">Please select a type:</option>
                            <option value="map" selected>map</option>
                            <option value="bumpMap">bump</option>
                            <option value="normalMap">normal</option>
                        </select>
                    </div>
                </div>
                <div class="clearfix"></div>

                <div class="form-group">
                    <h6>Please select a permission for the texture:</h6>
                    <label class="control-label col-sm-3">Permissions:</label>
                    <div class="col-sm-4">
                        <select class="form-control" id="permissions-list" name="permissions">
                            <option value="">Please select:</option>
                            <option value="public" selected>public</option>
                            <option value="private">private</option>
                            <option value="onsale">for sale</option>
                        </select>
                    </div>
                </div>
                <div class="clearfix"></div>
            </form>
        </div>

    </div>

    <div id="left-side">
        <div id="left-side-pinbtn" title="click this to pin/unpin panel"></div>
        <div id="left-side-content">
            <h2>Icon:<img id="icon-img" width="32" height="32"></h2>  <!-- title="icon" -->
            <h2>Preview:</h2>
            <div><img id="preview-img" width="256" height="347"></div>  <!-- title="preview" -->
            <h2>Texture:</h2>
            <div><img id="texture-img" width="256" height="256" crossorigin="anonymous"></div>  <!-- title="texture" -->
        </div>
    </div>

</section>

    <!-- BOOTSTRAP BOOTBOX -->

<script src="/bootstrap/js/bootstrap.min.js"></script>
<script src="/bootstrap/js/bootbox.min.js"></script>
<script src="/js/alerts.js"></script>
<script src="/js/DeviceDetector.js"></script>

    <!-- UTILITIES -->
    
<script src="/js/ZipLoader.js"></script>
<script src="/js/colorpicker.js"></script>
<script src="/js/messg.min.js"></script>
<script src="/js/spectrum.js"></script>
<script src="/js/img2matrix.js"></script>

    <!-- THREEJS -->

<script src="/three/r78/js/three.js"></script>
<script src="/three/r78/js/controls/EditorControls.js"></script>
<script src="/three/r78/js/controls/FirstPersonControls.js"></script>
<script src="/three/r78/js/Detector.js"></script>
<script src="/three/r78/js/renderers/Projector.js"></script>
<script src="/js/Animation.js"></script>
<script src="/js/AnimationHandler.js"></script>
<script src="/js/KeyFrameAnimation.js"></script>
<script src="/js/BVHImport.js"></script>
<script src="/js/SceneHelpers.js"></script>

<script src="/avatar-editor/v/0.2.5/js/SidePanels.js"></script>
<script src="/avatar-editor/v/0.2.5/js/helpers.js"></script>

<script>

//  dress3_scene.js

    var sceneContainerSelector = "#render-container";
    var fontPath = "/three/r78/js/fonts/helvetiker_regular.typeface.json";

    if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

    var container = $(sceneContainerSelector)[0];
    var scene, camera, renderer, controls;
    var sceneLights, axisCustomHelper, axisOriginHelper;
    var projector, keyboard, clock;

    scene = new THREE.Scene();
    scene.background = new THREE.Color( 0xeeeeee );

    var fov = 50, near = 1, far = 10000;
    var camera = new THREE.PerspectiveCamera( fov, aspect(), near, far );
    camera.position.set( 0, 20, 35 );
    camera.rotation.set( 0, 0, 0 );
    camera.name = "FPS_CAMERA" ;

    scene.add(directionalLight(0xffffff,  1000, 1000,  1000, 0.5));
    scene.add(directionalLight(0xffffff,  1000, 1000, -1000, 0.5)); 
    scene.add(directionalLight(0xffffff, -1000, 1000,  1000, 0.5)); 
    scene.add(directionalLight(0xffffff, -1000, 1000, -1000, 0.5));
    scene.add(directionalLight(0xffffff,     0,-5000,     0, 0.3));

    projector = new THREE.Projector();
//  keyboard = new KeyboardState();
    clock = new THREE.Clock();

    renderer = new THREE.WebGLRenderer({
        antialias: true,
        preserveDrawingBuffer: true,
    });

    renderer.shadowMap.enabled = true;
    renderer.setPixelRatio( window.devicePixelRatio );
    renderer.setSize( container.offsetWidth, container.offsetHeight );
//  container.appendChild( renderer.domElement );

    controls = new THREE.EditorControls(camera, renderer.domElement);
    $(container).on("mouseenter", function(){ controls.enabled = true; });
    $(container).on("mouseleave", function(){ controls.enabled = false; });
    
    $(window).on( "resize", function () {
        camera.aspect = aspect();
        camera.updateProjectionMatrix();
        renderer.setSize( container.offsetWidth, container.offsetHeight );
    });

    function aspect(){ 
        return (container.offsetWidth / container.offsetHeight); 
    }

</script>


<script>

//  dress3_runtime.js

    if (!isMobile && !leftSidePinBtn.pinned) toggleSidePanel(leftSidePinBtn);

    function animate(){
        windowAnimationFrameRequestID = requestAnimationFrame( animate );
        update();
        render();
    }

    function render(){
        renderer.render( scene, camera );
    }

    function update() {
        var delta = clock.getDelta();
        var time = clock.getElapsedTime();
    //  if (!!keyboard) keyboard.update(delta);
        if ( isMobile && !!mesh ) controls.focus( mesh, true );
    }

//  =======================================================================================  //

//  Deallocate renderer to avoid memory leaks. // VERY IMPORTANT //
    function deallocateRendererContext( renderer ){

    //  sources: "https://stackoverflow.com/questions/21548247/clean-up-threejs-webgl-contexts",
    //        "https://github.com/mrdoob/three.js/blob/r78/src/renderers/WebGLRenderer.js#L308".

        renderer.forceContextLoss(); //  THE MOST IMPORTANT  //
        renderer.dispose();          //  Removes the "webglcontextlost" event listener.

        renderer.context    = null;
        renderer.domElement = null;
        renderer            = null;
    }

//  =======================================================================================  //

</script>

<script>

//  dress3_startup.js

    var mesh;

    w3.getHttpObject( "/avatar-editor/v/0.2.5/assets/HF_DressLayer_FemaleBodyKitv05_v03.js", function(json){
        mesh = loadSkinnedAsset( json );
        scene.add( mesh );
        controls.focus( mesh, true );
        debugMode && console.log( "mesh:", mesh );

        if (!!mesh) {
            animate();
            camera.lookAt( controls.center );
            container.appendChild( renderer.domElement );
        }

    });

    function loadSkinnedAsset( json ){
        var loader = new THREE.JSONLoader();
        var object = loader.parse( json );

        var geometry = object.geometry;
        geometry.computeFaceNormals();
        geometry.computeVertexNormals();
        geometry.computeBoundingBox();
        geometry.computeBoundingSphere();

        var material = new THREE.MeshStandardMaterial({
            skinning:true, 
            transparent:true,
            side: THREE.FrontSide, // THREE.DoubleSide,
        });

        var skinned = new THREE.SkinnedMesh( geometry, material );

        skinned.frustumCulled = false;  // VERY IMPORTANT // 
        skinned.position.set( 0, 0, 0 );
        skinned.rotation.set( 0, 0, 0 ); 
        skinned.scale.set( 1, 1, 1 );
        skinned.renderDepth = 1;

        return skinned;
    }
    
</script>

<script>

    // dress3_controller.js

    var _icnflag = false;
    var _prvflag = false;
    var _txrflag = false;

    var errmsg = "URL is not valid. Please enter a valid image url.";
    var corsmsg = [
        "URL is not valid or remote image is not",
        "<a href='https://developer.mozilla.org/en-US/docs/Web/HTML/CORS_enabled_image' target='_blank'> CORS enabled. </a>",
        "Please enter a",
        "<a href='https://en.wikipedia.org/wiki/Cross-origin_resource_sharing' target='_blank'> cross-origin </a>",
        "image valid address."
    ].join("");
    
    var nameTxtfieldSelector = "#name-tf";
    var typeDropListSelector = "#type-list";
    var iconImgSelector = "#icon-img";
    var previewImgSelector = "#preview-img";
    var textureImgSelector = "#texture-img";
    var iconTxtfieldSelector = "#icon-tf";
    var previewTxtfieldSelector = "#preview-tf";
    var textureTxtfieldSelector = "#texture-tf";
    var imgHeightAutoSelector = ".img-height-auto";
    var imgHeightAutoClassname = "img-height-auto";

//  Icon.

    $(iconTxtfieldSelector).on("paste", function(e){
        debugMode && console.log( "paste:" );
    });

    $(iconTxtfieldSelector).on("change", function(e){
    //  e.preventDefault();
        var _self = this;
        var _img = $(iconImgSelector)[0];
        
        if ( this.value == "" ){
            _icnflag = false;
            _img.removeAttribute("src");

            debugMode && console.log( "Icon URL:", _img.src );
            debugMode && console.log( "icon-flag:", _icnflag );
            return; 
        }
        
        debugMode && console.log( iconTxtfieldSelector + ":", this.value );
        
        _img.onload = onLoad;
        _img.onerror = onError;
        _img.src = this.value;

        function onLoad(){
            _icnflag = true;
            debugMode && console.log( "load:", _icnflag );
            debugMode && console.log( "Icon URL:", this.src);
        }

        function onError(){
            _icnflag = false;
            _self.value = "";

            this.removeAttribute("src");
            bootboxErrorAlert( errmsg );

            debugMode && console.log( "Icon URL:", this.src );
            debugMode && console.log( "icon-flag:", _icnflag );
        }

    });


//  Preview.

    $(previewTxtfieldSelector).on("paste", function(e){
        debugMode && console.log( "paste:" );
    });

    $(previewTxtfieldSelector).on("change", function(e){
    //  e.preventDefault();
        var _self = this;
        var _img = $(previewImgSelector)[0];

        if ( this.value == "" ) { 
            _prvflag = false;
            _img.removeAttribute("src");

            w3.removeClass(_img, imgHeightAutoClassname);
            if (_img.classList.length == 0) _img.removeAttribute("class");

            debugMode && console.log( "Preview URL:", _img.src );
            debugMode && console.log( "preview-flag:", _prvflag );
            return; 
        }

        debugMode && console.log(previewTxtfieldSelector + ":", this.value );
        
        _img.onload = onLoad;
        _img.onerror = onError;
        _img.src = this.value;

        w3.addClass(_img, imgHeightAutoClassname);

        function onLoad(){
            _prvflag = true;
            debugMode && console.log( "load:", _prvflag );
            debugMode && console.log( "Preview URL:", this.src);
        }

        function onError(){
            _prvflag = false;
            _self.value = "";

            this.removeAttribute("src");
            w3.removeClass(this, imgHeightAutoClassname);
            if (this.classList.length == 0) this.removeAttribute("class");

            bootboxErrorAlert( errmsg );

            debugMode && console.log( "Preview URL:", this.src );
            debugMode && console.log( "preview-flag:", _prvflag );
        }
    });


//  Texture.

    $(textureTxtfieldSelector).on("paste", function(e){
        debugMode && console.log( "paste:" );
    });

    $(textureTxtfieldSelector).on("change", function(e){
    //  e.preventDefault();
        var _self = this;
        var _img = $(textureImgSelector)[0];

    //  Reset mesh textures.
        deallocateMeshTextures( mesh );

        if ( this.value == "" ) { 
            _txrflag = false;
            _img.removeAttribute("src");

            w3.removeClass(_img, imgHeightAutoClassname);
            if (_img.classList.length == 0) _img.removeAttribute("class");
            
            debugMode && console.log( "Texture URL:", this.src );
            debugMode && console.log( "texture-flag:", _txrflag );
            return;
        }

        debugMode && console.log(textureTxtfieldSelector + ":", this.value );

        _img.onload = onLoad;
        _img.onerror = onError;
        _img.src = this.value;

        w3.addClass(_img, imgHeightAutoClassname);

        function onLoad(){
            _txrflag = true;
            debugMode && console.log( "texture-flag:", _txrflag );
            debugMode && console.log( "Texture URL:", this.src);
            debugMode && console.log( "load completed:", this.complete);

        //  Apply texture on mesh.
            var name = $(nameTxtfieldSelector).val();
            var type = $(typeDropListSelector).val();

        //  if (this.complete){
            var texture = new THREE.Texture(this);

            if (!texture) {
                _txrflag = false;
                _self.value = "";
                this.removeAttribute("src");
                w3.removeClass(this, imgHeightAutoClassname);
                if (this.classList.length == 0) this.removeAttribute("class");
                bootboxErrorAlert( "Can not create texture. Sorry!" );
                debugMode && console.log( "Texture URL:", this.src );
                debugMode && console.log( "texture-flag:", _txrflag );
                return;
            }

            texture.sourceFile = this.src;
            if (name != "") texture.name = name;
            debugMode && console.log( "texture:", texture );

            if (!mesh) return;
            
            var material = mesh.material;
            if (!material) {
                material = new THREE.MeshStandardMaterial({
                    skinning:true, 
                    transparent:true,
                    side: THREE.FrontSide, // THREE.DoubleSide,
                });
            }

            if (!type || type == "") {
                type = "map"; 
                $(typeDropListSelector).val( type );
            }
            if ( type == "bumpMap" ) material.bumpScale = 0.02;

            material[ type ] = texture;
            material.transparent = true;
            material[ type ].needsUpdate = true;
            material.needsUpdate = true;
            debugMode && console.log( "material:", mesh.material );

        //  }
        }

        function onError(){
            _txrflag = false;
            _self.value = "";

            this.removeAttribute("src");
            w3.removeClass(this, imgHeightAutoClassname);
            if (this.classList.length == 0) this.removeAttribute("class");

            bootboxErrorAlert( corsmsg );

            debugMode && console.log( "Texture URL:", this.src );
            debugMode && console.log( "texture-flag:", _txrflag );
            
        //  Reset mesh textures.
            deallocateMeshTextures( mesh );
        }
    });

    function deallocateMeshTextures( mesh ){
        if (!mesh) return;
        if (!mesh.material) return;

        var deallocate = {};
    //  if (!!mesh && !!mesh.material){
        if (!!mesh.material.map) { 
            deallocate.map = mesh.material.map;
            mesh.material.map = null; 
        }
        if (!!mesh.material.bumpMap) { 
            deallocate.bumpMap = mesh.material.bumpMap; 
            mesh.material.bumpMap = null; 
        }
        if (!!mesh.material.normalMap) { 
            deallocate.normalMap = mesh.material.normalMap; 
            mesh.material.normalMap = null; 
        }
        mesh.material.needsUpdate = true;
        debugMode && console.log( "deallocate:", Object.keys(deallocate) );
        for (var name in deallocate){
            deallocate[name].dispose();
            delete deallocate[name];
        }
        debugMode && console.log("deallocate:", deallocate);
    //  }
    }

    function deallocate(texture){
        if (!texture) return;
        if (!texture.sourceFile) return;
        if ( texture.sourceFile == "" ) return;

        var deallocate = {};
        deallocate.texture = texture;
        texture = null;
        var src_file = deallocate.texture.sourceFile;
        debugMode && console.log( "deallocate sourceFile:", src_file );

        if (!!mesh && !!mesh.material){

            if (!!mesh.material.map && mesh.material.map.sourceFile == src_file) {
                deallocate.map = mesh.material.map;
                mesh.material.map = null; 
            }
            if (!!mesh.material.bumpMap && mesh.material.bumpMap.sourceFile == src_file) {
                deallocate.bumpMap = mesh.material.bumpMap; 
                mesh.material.bumpMap = null; 
            }
            if (!!mesh.material.normalMap && mesh.material.normalMap.sourceFile == src_file) { 
                deallocate.normalMap = mesh.material.normalMap; 
                mesh.material.normalMap = null; 
            }
            mesh.material.needsUpdate = true;

        }

        debugMode && console.log( "deallocate:", Object.keys(deallocate) );
        for (var name in deallocate){
            deallocate[name].dispose();
            delete deallocate[name];
        }
        debugMode && console.log("deallocate:", deallocate);
    }

//  Type.

    $(typeDropListSelector).on("change", function(e){
    //  e.preventDefault();
        var _img = $(textureImgSelector)[0];

        if (this.value == "bumpMap") mesh.material.bumpScale = 0.01;

        _txrflag = false;
        _img.removeAttribute("src");
        $(textureTxtfieldSelector).val("");
        w3.removeClass(_img, imgHeightAutoClassname);
        if (_img.classList.length == 0) _img.removeAttribute("class");
        deallocateMeshTextures( mesh );        

        debugMode && console.log( "Texture URL:", _img.src );
        debugMode && console.log( "texture-flag:", _txrflag );

    });

/*
    //  material.
        var material;
        if (!!mesh && !!mesh.material) material = mesh.material;
        if (!material) return;

    //  Map.
        if (this.value == "map"){
            if (!!material.map && !material.bumpMap){
                deallocate(material.map);
            }
            if (!!material.map && !!material.bumpMap){
                if (material.map.uuid != material.bumpMap.uuid){
                    deallocate(material.map);
                } else {
                    material.map = null;
                }
            }
        //  if (!material.map && !!material.bumpMap){}
        //  if (!material.map && !material.bumpMap){}
        }

    //  BumpMap.
        if (this.value == "bumpMap"){
            material.bumpScale = 0.05;
            if (!!material.map && !material.bumpMap){
                material.bumpMap = material.map;
            }
            if (!!material.map && !!material.bumpMap){
                if ( material.map.uuid != material.bumpMap.uuid ){
                    deallocate(material.bumpMap);
                    material.bumpMap = material.map;
                } else {
                    material.bumpMap = null;
                }
            }
            if (!material.map && !!material.bumpMap){
                deallocate(material.bumpMap);
            }
        //  if (!material.map && !material.bumpMap){}
        }

    //  NormalMap.
        if (this.value == "normalMap"){
            if (!!material.normalMap) deallocate(material.normalMap);
        }
*/


</script>

<script>

//  animate();

</script>

</body>
</html>
